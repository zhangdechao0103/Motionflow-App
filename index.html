<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <title>Motiflow VFX - v24 Robust</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #050505; color: #e0e0e0; }
        
        .portal-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #222; position: relative; overflow: hidden; }
        .portal-card:hover { transform: translateY(-5px); border-color: var(--accent-color); box-shadow: 0 10px 30px -10px var(--shadow-color); }
        
        .settings-panel { transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .settings-panel.open { transform: translateX(0); }
        
        .model-item { cursor: pointer; padding: 10px; border-bottom: 1px solid #222; font-size: 11px; color: #666; display: flex; justify-content: space-between; align-items: center; }
        .model-item:hover { background: #111; color: white; }
        .model-item.active { background: #1e3a8a; color: #93c5fd; border-left: 3px solid #3b82f6; }
        .tag-rec { background: #064e3b; color: #34d399; padding: 2px 6px; border-radius: 4px; font-size: 9px; }
        
        .upload-active { animation: pulse-ring 2s infinite; border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
    </style>
</head>
<body class="min-h-screen bg-[#050505] flex flex-col overflow-x-hidden">

    <nav class="sticky top-0 z-40 bg-[#0a0a0a]/90 backdrop-blur-md border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-white">24</div>
                <span class="text-lg font-bold tracking-tight text-white">MOTIFLOW <span class="text-blue-500 font-normal">| ROBUST</span></span>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2 text-[10px] text-zinc-500 bg-zinc-900 px-3 py-1 rounded-full border border-zinc-800">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span id="current-model-label" class="text-zinc-300 font-mono">...</span>
                </div>
                <button onclick="toggleSettings()" class="text-zinc-400 hover:text-white text-xs px-3 py-1 rounded border border-zinc-800 hover:bg-zinc-800 transition">
                    <i class="fas fa-cog"></i> 设置
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-7xl mx-auto w-full p-6 flex flex-col gap-8">
        
        <section class="flex flex-col md:flex-row gap-6 items-stretch h-auto md:h-48">
            <div id="drop-area" class="relative group w-full md:w-1/3 border-2 border-dashed border-zinc-800 rounded-2xl hover:border-blue-500 transition cursor-pointer flex flex-col items-center justify-center bg-zinc-900/20 py-8 md:py-0" onclick="triggerUpload()">
                <input type="file" id="file-input" class="hidden" accept="image/*">
                <i class="fas fa-cloud-upload-alt text-4xl mb-3 text-zinc-600 group-hover:text-blue-500 transition"></i>
                <p class="text-xs text-zinc-500 font-bold group-hover:text-zinc-300">点击 / 拖拽图片</p>
                <p class="text-[10px] text-zinc-600 mt-1">智能容错引擎已启动</p>
            </div>

            <div class="w-full md:w-2/3 bg-black border border-zinc-800 rounded-2xl p-4 flex flex-col relative">
                <div class="flex justify-between items-center mb-4 border-b border-zinc-800 pb-2">
                    <span class="text-xs font-bold text-blue-400"><i class="fas fa-robot"></i> AI ANALYSIS HUB</span>
                    <button onclick="resetAll()" class="text-[10px] text-zinc-500 hover:text-white flex items-center gap-1 bg-zinc-900 px-2 py-1 rounded">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                </div>
                <div class="flex-1 flex flex-col justify-center gap-4">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-zinc-500 w-16 text-right font-bold">CN (花瓣)</span>
                        <input type="text" id="cn-keywords" class="flex-1 bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-xs text-white focus:border-blue-500 outline-none transition" placeholder="等待分析...">
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-zinc-500 w-16 text-right font-bold">EN (专业)</span>
                        <input type="text" id="en-keywords" class="flex-1 bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-xs text-white focus:border-blue-500 outline-none transition" placeholder="Waiting for analysis...">
                    </div>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="show-preview" class="accent-blue-500" checked onchange="togglePreviewArea()">
                        <label for="show-preview" class="text-[10px] text-zinc-500 cursor-pointer select-none">显示 Tenor 预览</label>
                    </div>
                    <button onclick="refreshLinks()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-2 rounded font-bold shadow-lg shadow-blue-900/50 transition">
                        <i class="fas fa-bolt"></i> 执行搜索
                    </button>
                </div>
            </div>
        </section>

        <section>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a id="link-huaban" target="_blank" class="portal-card bg-[#c8222c]/10 rounded-xl p-4 flex flex-col gap-2 group cursor-pointer" style="--accent-color: #c8222c; --shadow-color: rgba(200, 34, 44, 0.4);">
                    <div class="flex justify-between"><i class="fas fa-flower text-xl text-[#c8222c]"></i><i class="fas fa-external-link-alt text-[#c8222c] opacity-50"></i></div>
                    <div><h3 class="font-bold text-white text-sm">花瓣网</h3><p class="text-[10px] text-zinc-400">中文灵感库</p></div>
                </a>
                <a id="link-pinterest" target="_blank" class="portal-card bg-[#bd081c]/10 rounded-xl p-4 flex flex-col gap-2 group cursor-pointer" style="--accent-color: #bd081c; --shadow-color: rgba(189, 8, 28, 0.4);">
                    <div class="flex justify-between"><i class="fab fa-pinterest text-xl text-[#bd081c]"></i><i class="fas fa-external-link-alt text-[#bd081c] opacity-50"></i></div>
                    <div><h3 class="font-bold text-white text-sm">Pinterest</h3><p class="text-[10px] text-zinc-400">全球参考</p></div>
                </a>
                <a id="link-artstation" target="_blank" class="portal-card bg-[#13aff0]/10 rounded-xl p-4 flex flex-col gap-2 group cursor-pointer" style="--accent-color: #13aff0; --shadow-color: rgba(19, 175, 240, 0.4);">
                    <div class="flex justify-between"><i class="fab fa-artstation text-xl text-[#13aff0]"></i><i class="fas fa-external-link-alt text-[#13aff0] opacity-50"></i></div>
                    <div><h3 class="font-bold text-white text-sm">ArtStation</h3><p class="text-[10px] text-zinc-400">专业美术</p></div>
                </a>
                <a id="link-bilibili" target="_blank" class="portal-card bg-[#00aeec]/10 rounded-xl p-4 flex flex-col gap-2 group cursor-pointer" style="--accent-color: #00aeec; --shadow-color: rgba(0, 174, 236, 0.4);">
                    <div class="flex justify-between"><i class="fab fa-bilibili text-xl text-[#00aeec]"></i><i class="fas fa-external-link-alt text-[#00aeec] opacity-50"></i></div>
                    <div><h3 class="font-bold text-white text-sm">Bilibili</h3><p class="text-[10px] text-zinc-400">视频教程</p></div>
                </a>
            </div>
        </section>

        <section id="preview-section" class="border-t border-zinc-900 pt-6 transition-all duration-300">
            <h2 class="text-xs font-bold text-zinc-500 mb-4 flex items-center gap-2">
                <i class="fas fa-images"></i> 快速预览 (Tenor)
            </h2>
            <div id="results-grid" class="grid grid-cols-2 md:grid-cols-6 gap-3 min-h-[100px]">
                <div class="col-span-full text-center py-10 text-zinc-700 text-xs">
                    等待图片上传...
                </div>
            </div>
        </section>

    </main>

    <div id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-[400px] bg-[#0d0d0d] border-l border-zinc-800 z-50 p-6 shadow-2xl flex flex-col gap-4">
        <div class="flex justify-between items-center">
            <h2 class="font-bold text-white">⚙️ 设置</h2>
            <button onclick="toggleSettings()" class="text-zinc-500 hover:text-white">✕</button>
        </div>
        
        <div>
            <label class="block text-xs font-bold text-zinc-500 mb-1">API Key</label>
            <input type="text" id="api-key-input" class="w-full bg-zinc-900 border border-zinc-700 rounded p-2 text-xs text-white font-mono" readonly>
        </div>

        <div class="flex-1 flex flex-col min-h-0">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-xs font-bold text-zinc-500">模型列表 (已屏蔽实验模型)</label>
                <button onclick="scanModels()" class="text-[10px] text-blue-400 hover:text-blue-300">刷新</button>
            </div>
            <div id="model-list" class="flex-1 bg-zinc-900 border border-zinc-700 rounded overflow-y-auto"></div>
        </div>

        <button onclick="saveSettings()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold">保存并应用</button>
        <div class="console-box" id="debug-log">Log initialized.</div>
    </div>
    <div id="settings-overlay" onclick="toggleSettings()" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm"></div>

    <script>
        // --- 核心配置：使用新 Key ---
        const NEW_KEY = "AIzaSyB1mVPeECC27nWMhn49NBOT8_-PIJQmmEI";
        const TENOR_KEY = "LIVDSRZULELA";
        
        let CONFIG = {
            apiKey: NEW_KEY,
            endpoint: "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent"
        };

        // --- 1. 初始化 ---
        function init() {
            if(localStorage.getItem('motiflow_v24')) {
                const saved = JSON.parse(localStorage.getItem('motiflow_v24'));
                if(saved.endpoint) CONFIG.endpoint = saved.endpoint;
            }
            CONFIG.apiKey = NEW_KEY; // 强制覆盖
            document.getElementById('api-key-input').value = CONFIG.apiKey;
            updateModelLabel();
            scanModels(true);
        }

        function updateModelLabel() {
            const name = CONFIG.endpoint.match(/models\/(.*?):/)?.[1] || "Default (1.5-flash)";
            document.getElementById('current-model-label').innerText = name;
        }

        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('open');
            document.getElementById('settings-overlay').classList.toggle('hidden');
        }

        function log(msg) {
            const box = document.getElementById('debug-log');
            box.innerText += `\n> ${msg}`;
            box.scrollTop = box.scrollHeight;
        }

        // --- 2. 扫描模型 (带过滤) ---
        async function scanModels(silent = false) {
            const list = document.getElementById('model-list');
            if(!silent) list.innerHTML = '<div class="text-zinc-500 text-xs p-4">Scanning...</div>';

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${CONFIG.apiKey}`);
                const data = await res.json();
                list.innerHTML = "";
                
                const recommended = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-2.0-flash-exp'];
                const blocked = ['nano', 'banana', 'gemini-3', 'preview', 'gemma']; // 屏蔽不稳定模型

                if(data.models) {
                    data.models.forEach(m => {
                        const name = m.name.replace('models/', '');
                        
                        // 过滤逻辑
                        const isBlocked = blocked.some(b => name.includes(b));
                        const isVision = m.supportedGenerationMethods?.includes('generateContent');

                        if(isVision && !isBlocked) {
                            const div = document.createElement('div');
                            const isActive = CONFIG.endpoint.includes(name);
                            div.className = `model-item ${isActive ? 'active' : ''}`;
                            
                            let html = `<span>${name}</span>`;
                            if(recommended.some(r => name.includes(r))) html += `<span class="tag-rec">推荐</span>`;
                            
                            div.innerHTML = html;
                            div.onclick = () => {
                                CONFIG.endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${name}:generateContent`;
                                document.querySelectorAll('.model-item').forEach(e => e.classList.remove('active'));
                                div.classList.add('active');
                                updateModelLabel();
                            };
                            list.appendChild(div);
                        }
                    });
                }
            } catch(e) { 
                if(!silent) list.innerHTML = `<div class="text-red-500 text-xs p-4">Error: ${e.message}</div>`;
            }
        }

        function saveSettings() {
            localStorage.setItem('motiflow_v24', JSON.stringify(CONFIG));
            alert("设置已保存");
            toggleSettings();
        }

        // --- 3. 上传与分析 (修复 undefined) ---
        function triggerUpload() { document.getElementById('file-input').click(); }

        document.getElementById('file-input').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if(!file) return;

            document.getElementById('drop-area').classList.add('upload-active');
            document.getElementById('cn-keywords').value = ""; 
            document.getElementById('en-keywords').value = "";
            document.getElementById('cn-keywords').placeholder = "AI 正在分析...";
            document.getElementById('en-keywords').placeholder = "Analyzing...";
            document.getElementById('results-grid').innerHTML = '<div class="col-span-full text-center py-10 text-blue-500 animate-pulse text-xs">AI 正在思考...</div>';

            try {
                const base64 = await toBase64(file);
                
                // Prompt: 强制 JSON 格式
                const prompt = `You are a backend API. Identify the Game VFX style and element.
Output ONLY a JSON object. No markdown.
Structure: {"cn": "Chinese Keywords for Huaban", "en": "English Keywords for ArtStation", "tenor": "Simple English keyword for GIF"}
Example: {"cn": "Unity 刀光", "en": "Unity Slash VFX", "tenor": "Slash VFX"}
`;

                const res = await fetch(`${CONFIG.endpoint}?key=${CONFIG.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: base64.split(',')[1] } }
                        ]}],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                if(!res.ok) throw new Error(`API Error ${res.status}`);

                const raw = await res.text();
                
                // 解析逻辑：容错处理
                let result = {};
                try {
                    let jsonStr = raw;
                    if(raw.includes('```json')) jsonStr = raw.split('```json')[1].split('```')[0].trim();
                    else if(raw.includes('```')) jsonStr = raw.split('```')[1].split('```')[0].trim();
                    
                    // 尝试解析 JSON
                    const parsed = JSON.parse(jsonStr);
                    // 提取 content
                    if(parsed.candidates) {
                       const text = parsed.candidates[0].content.parts[0].text;
                       // 二次解析 text 中的 JSON
                       try {
                           result = JSON.parse(text.replace(/```json/g,'').replace(/```/g,'').trim());
                       } catch(e) {
                           // 如果 text 不是 JSON，直接当做关键词
                           result = { cn: "解析异常: " + text.slice(0,10), en: text, tenor: text };
                       }
                    }
                } catch(e) {
                    console.log("Parse Fail", e);
                    result = { cn: "识别失败", en: "Error", tenor: "vfx" };
                }

                // 填入数据 (防止 undefined)
                document.getElementById('cn-keywords').value = result.cn || "游戏特效";
                document.getElementById('en-keywords').value = result.en || "Game VFX";
                refreshLinks(result.tenor || result.en);

            } catch(e) {
                alert("出错: " + e.message);
                document.getElementById('results-grid').innerHTML = '<div class="col-span-full text-center py-10 text-red-500 text-xs">出错</div>';
            } finally {
                document.getElementById('drop-area').classList.remove('upload-active');
                this.value = ''; 
            }
        });

        // --- 4. 辅助功能 ---
        function resetAll() {
            document.getElementById('cn-keywords').value = "";
            document.getElementById('en-keywords').value = "";
            document.getElementById('results-grid').innerHTML = '<div class="col-span-full text-center py-10 text-zinc-700 text-xs">等待图片上传...</div>';
            document.getElementById('drop-area').classList.remove('upload-active');
        }

        function refreshLinks(tenorQueryOverride) {
            const cn = document.getElementById('cn-keywords').value.trim();
            const en = document.getElementById('en-keywords').value.trim();

            document.getElementById('link-huaban').href = `https://huaban.com/search/?q=${encodeURIComponent(cn)}`;
            document.getElementById('link-pinterest').href = `https://www.pinterest.com/search/pins/?q=${encodeURIComponent(en)}`;
            document.getElementById('link-artstation').href = `https://www.artstation.com/search?sort_by=relevance&query=${encodeURIComponent(en)}`;
            document.getElementById('link-bilibili').href = `https://search.bilibili.com/all?keyword=${encodeURIComponent(cn + " 教程")}`;

            const showTenor = document.getElementById('show-preview').checked;
            if (showTenor) {
                const query = (tenorQueryOverride || en) + " unity ue5 gameplay -meme"; 
                searchTenor(query);
            }
        }

        async function searchTenor(query) {
            const grid = document.getElementById('results-grid');
            grid.innerHTML = '<div class="col-span-full text-center py-10 text-zinc-500 text-xs">正在搜索预览...</div>';
            try {
                const res = await fetch(`https://g.tenor.com/v1/search?q=${encodeURIComponent(query)}&key=${TENOR_KEY}&limit=12&media_filter=minimal`);
                const data = await res.json();
                if(data.results && data.results.length) {
                    grid.innerHTML = data.results.map(item => `
                        <div class="aspect-square bg-zinc-900 rounded overflow-hidden cursor-pointer opacity-80 hover:opacity-100 transition border border-zinc-800 hover:border-blue-500" onclick="window.open('${item.itemurl}', '_blank')">
                            <img src="${item.media[0].tinygif.url}" class="w-full h-full object-cover" loading="lazy">
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<div class="col-span-full text-center py-10 text-zinc-600 text-xs">无相关素材</div>';
                }
            } catch(e) {
                grid.innerHTML = '<div class="col-span-full text-center py-10 text-zinc-600 text-xs">预览加载失败</div>';
            }
        }

        function togglePreviewArea() {
            const section = document.getElementById('preview-section');
            const show = document.getElementById('show-preview').checked;
            if(show) { section.classList.remove('opacity-30', 'pointer-events-none'); refreshLinks(); } 
            else { section.classList.add('opacity-30', 'pointer-events-none'); }
        }

        function toBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
            });
        }

        init();
    </script>
</body>
</html>

