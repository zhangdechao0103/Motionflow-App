<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <title>Motiflow VFX - 游戏动效引擎</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 游戏/赛博朋克风格配色 */
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #0a0a0a; color: #e0e0e0; }
        .glass { background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        /* 霓虹渐变 */
        .accent-gradient { background: linear-gradient(135deg, #00f2ea 0%, #ff0055 100%); }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 100; opacity: 0; transition: opacity 0.3s; }
        .modal.active { display: flex; opacity: 1; }
        .grid-item { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        /* 强调鼠标悬停效果 */
        .vfx-card:hover { border-color: #00f2ea; box-shadow: 0 0 20px rgba(0, 242, 234, 0.2); }
    </style>
</head>
<body class="min-h-screen pb-20 bg-[url('https://cdn.pixabay.com/photo/2018/08/23/07/35/thunderstorm-3625405_1280.jpg')] bg-cover bg-fixed bg-blend-multiply">

    <nav class="glass sticky top-0 z-50 px-8 py-4 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 accent-gradient rounded-sm skew-x-[-10deg] flex items-center justify-center font-black text-black shadow-lg shadow-cyan-500/20">VFX</div>
            <span class="text-xl font-black tracking-tighter italic text-white">MOTIFLOW <span class="text-cyan-400">ENGINE</span></span>
        </div>
        <div class="text-[10px] text-cyan-500 font-mono flex items-center gap-2 uppercase tracking-widest">
            <span class="w-2 h-2 rounded-full bg-cyan-500 shadow-[0_0_8px_#00f2ea] animate-pulse"></span> Tenor VFX Link Active
        </div>
    </nav>

    <header class="max-w-4xl mx-auto pt-20 pb-16 px-6">
        <div id="drop-zone" class="relative p-16 border-2 border-dashed border-zinc-800/50 rounded-3xl bg-black/40 text-center hover:border-cyan-500/50 transition-all duration-300 cursor-pointer group backdrop-blur-md">
            <input type="file" id="file-input" class="hidden" accept="image/*">
            <div id="status-ui">
                <div class="text-6xl mb-6 group-hover:scale-110 transition duration-300 drop-shadow-[0_0_15px_rgba(0,242,234,0.5)]">⚡️</div>
                <h2 class="text-2xl font-black mb-2 text-white uppercase tracking-tight">投入游戏/动漫参考图</h2>
                <p class="text-cyan-300/70 text-sm font-mono">AI 将识别特效风格并检索 Tenor 实时 VFX 库</p>
            </div>
            <div id="ai-tags" class="mt-10 flex flex-wrap justify-center gap-2"></div>
        </div>
    </header>

    <main class="max-w-[1400px] mx-auto px-6">
        <div id="results-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            </div>
    </main>

    <div id="preview-modal" class="modal" onclick="closeModal()">
        <div class="w-full h-full flex flex-col items-center justify-center p-6" onclick="event.stopPropagation()">
            <div class="relative max-w-4xl max-h-[70vh] bg-zinc-900 rounded-xl overflow-hidden shadow-[0_0_50px_rgba(0,0,0,0.8)] border border-white/10">
                <img id="modal-img" class="w-full h-full object-contain">
            </div>
            
            <div class="mt-6 flex justify-between items-center w-full max-w-3xl">
                <div class="text-left">
                    <h3 class="text-lg font-bold text-white uppercase">VFX Preview</h3>
                    <p class="text-xs text-cyan-500 font-mono mt-1">Real-time Tenor Reference</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="saveToEagle()" class="px-8 py-3 bg-cyan-500 hover:bg-cyan-400 text-black rounded-sm skew-x-[-10deg] text-sm font-black transition shadow-lg shadow-cyan-500/20">
                        <span class="skew-x-[10deg] inline-block">⬇ GET ASSET (EAGLE)</span>
                    </button>
                    <button onclick="closeModal()" class="w-12 h-12 rounded-full bg-zinc-800/50 border border-white/10 flex items-center justify-center hover:bg-white/10 transition text-white">✕</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GEMINI_KEY = "AIzaSyB9ww1axSGsO4iYUt9UaOOJiBAuoa0wYOQ";
        // Tenor 官方测试 Key (稳定，但建议后期替换为自己的)
        const TENOR_KEY = "LIVDSRZULELA";

        let currentImgUrl = "";

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const resultsGrid = document.getElementById('results-grid');
        const aiTagsDiv = document.getElementById('ai-tags');
        const statusUi = document.getElementById('status-ui');

        // 拖拽事件处理
        dropZone.onclick = () => fileInput.click();
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
        });
        dropZone.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        async function handleFile(file) {
            if (!file) return;
            statusUi.innerHTML = `<div class="animate-spin text-4xl mb-4 drop-shadow-[0_0_10px_#00f2ea]">⚙️</div><p class="text-cyan-400 font-bold uppercase tracking-widest font-mono">Analyzing VFX Style...</p>`;
            resultsGrid.innerHTML = "";
            aiTagsDiv.innerHTML = "";

            try {
                const base64 = await toBase64(file);
                
                // --- 核心修改：专门针对 VFX 的提示词 ---
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [
                            // 关键：让 AI 输出非常具体的游戏/动漫特效关键词
                            { text: "Analyze the visual effects (VFX) style of this image. Output 3 very specific English search keywords suitable for finding similar game VFX or anime effects on a GIF site. Examples: 'anime fire explosion', 'sci-fi shield energy', 'pixel art magic spell', 'genshin impact style water'. Output only keywords, comma separated." },
                            { inline_data: { mime_type: "image/jpeg", data: base64.split(',')[1] } }
                        ]}]
                    })
                });

                const data = await response.json();
                const keywords = data.candidates[0].content.parts[0].text.trim().toLowerCase();
                
                renderTags(keywords);
                searchTenor(keywords);

            } catch (err) {
                console.error(err);
                // 失败时的保底搜索词，确保是 VFX 相关的
                searchTenor("game vfx explosion, anime magic effect");
            }
        }

        async function searchTenor(query) {
            statusUi.innerHTML = `<div class="text-3xl mb-2">⚡️</div><p class="text-cyan-300 font-medium">VFX Link Established</p>`;
            
            try {
                // --- 核心修改：调用 Tenor API ---
                // 使用 media_filter=minimal 获取较小的 GIF 用于列表展示，提高加载速度
                const res = await fetch(`https://g.tenor.com/v1/search?q=${encodeURIComponent(query)}&key=${TENOR_KEY}&limit=16&media_filter=minimal`);
                const data = await res.json();

                if (data.results.length === 0) {
                    resultsGrid.innerHTML = `<p class="col-span-4 text-zinc-500 text-center py-20 font-mono">NO VFX FOUND. TRY ANOTHER IMAGE.</p>`;
                    return;
                }

                resultsGrid.innerHTML = data.results.map((item, index) => {
                    // 获取用于列表的小图和用于预览的大图
                    const thumbUrl = item.media[0].tinygif.url;
                    const fullUrl = item.media[0].gif.url;
                    const title = item.content_description || query.split(',')[0] + " VFX";

                    return `
                        <div class="glass vfx-card rounded-lg overflow-hidden grid-item group cursor-pointer border border-white/10 transition-all" 
                             style="animation-delay: ${index * 0.05}s"
                             onclick="openModal('${fullUrl}')">
                            <div class="aspect-square bg-[#111] relative">
                                <img src="${thumbUrl}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-300" loading="lazy">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                                <div class="absolute bottom-3 left-3 opacity-0 group-hover:opacity-100 transition truncate right-3">
                                    <span class="text-white text-[10px] font-bold font-mono uppercase truncate">${title}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                resultsGrid.innerHTML = `<p class="col-span-4 text-red-500 text-center font-mono">VFX DATABASE CONNECTION FAILED</p>`;
            }
        }

        function openModal(url) {
            currentImgUrl = url;
            const modal = document.getElementById('preview-modal');
            const img = document.getElementById('modal-img');
            // 预览时使用高清 GIF
            img.src = url;
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('preview-modal').classList.remove('active');
            setTimeout(() => document.getElementById('modal-img').src = "", 300);
        }

        async function saveToEagle() {
            try {
                const res = await fetch("http://localhost:44324/api/item/addFromURL", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        url: currentImgUrl, 
                        name: "VFX_Ref_" + Date.now(), 
                        tags: ["Motiflow", "Game VFX", "Anime"] 
                    })
                });
                if (res.ok) alert("✅ VFX ASSET ACQUIRED (EAGLE)");
                else throw new Error();
            } catch (e) { alert("⚠️ EAGLE DISCONNECTED. Check client."); }
        }

        function renderTags(keywords) {
            aiTagsDiv.innerHTML = keywords.split(',').map(t => `<span class="px-3 py-1 bg-cyan-950 text-cyan-400 text-[10px] border border-cyan-500/30 uppercase tracking-widest font-bold font-mono skew-x-[-10deg]">${t.trim()}</span>`).join('');
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>
