<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <title>Motiflow VFX - è¯šå®æœç´¢ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #050505; color: #e0e0e0; }
        .glass { background: rgba(18, 18, 18, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* æ¸¸æˆæ„Ÿå¼ºè°ƒè‰² */
        .accent-cyan { color: #00e5ff; text-shadow: 0 0 15px rgba(0, 229, 255, 0.5); }
        .accent-border { border-color: #00e5ff; box-shadow: 0 0 15px rgba(0, 229, 255, 0.2); }
        
        /* äº¤äº’åé¦ˆ */
        .vfx-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #333; }
        .vfx-card:hover { transform: translateY(-4px); border-color: #00e5ff; z-index: 10; }

        /* å¤–éƒ¨æºæŒ‰é’®æ ·å¼ */
        .source-btn { transition: all 0.3s; position: relative; overflow: hidden; }
        .source-btn:hover { transform: scale(1.02); filter: brightness(1.2); }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 100; opacity: 0; transition: opacity 0.2s; }
        .modal.active { display: flex; opacity: 1; }
    </style>
</head>
<body class="min-h-screen pb-20 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-black to-black">

    <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-cyan-500 to-blue-600 rounded flex items-center justify-center font-bold text-black">M</div>
            <span class="text-lg font-bold tracking-tight text-white">MOTIFLOW <span class="text-cyan-500 font-normal">| REALTIME</span></span>
        </div>
        <div class="text-[10px] text-zinc-500 font-mono flex items-center gap-2">
            <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span> ONLINE MODE
        </div>
    </nav>

    <header class="max-w-4xl mx-auto pt-20 pb-10 px-6">
        <div id="drop-zone" class="relative p-12 border border-dashed border-zinc-700 rounded-2xl bg-zinc-900/40 text-center hover:border-cyan-500/50 hover:bg-zinc-900/60 transition-all duration-300 cursor-pointer group">
            <input type="file" id="file-input" class="hidden" accept="image/*">
            <div id="status-ui">
                <div class="text-6xl mb-6 opacity-80 group-hover:scale-110 transition duration-300 drop-shadow-[0_0_20px_rgba(0,229,255,0.4)]">ğŸ“¡</div>
                <h2 class="text-2xl font-bold mb-2 text-white">ä¸Šä¼ æ¸¸æˆ VFX å‚è€ƒ</h2>
                <p class="text-cyan-200/50 text-sm font-mono">AI æå–å…³é”®è¯ -> ç›´è¿èŠ±ç“£/Bç«™/Pinterest å®æ—¶æœç´¢</p>
            </div>
            
            <div id="analysis-panel" class="hidden mt-8 pt-6 border-t border-white/5">
                <div class="flex flex-col items-center">
                    <p class="text-[10px] text-zinc-500 uppercase tracking-widest mb-3">AI Analysis Result</p>
                    <div id="ai-tags" class="flex flex-wrap justify-center gap-2 mb-6"></div>
                    
                    <div id="portal-links" class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-2xl opacity-0 translate-y-2 transition-all duration-500">
                        <a id="link-huaban" target="_blank" class="source-btn flex items-center justify-center gap-3 p-4 rounded-xl bg-[#c8222c] text-white">
                            <span class="text-xl">ğŸŒ¸</span>
                            <div class="text-left">
                                <div class="text-[10px] opacity-70 font-bold">èŠ±ç“£ç½‘ HUABAN</div>
                                <div class="text-sm font-bold truncate w-32" id="text-huaban">ç­‰å¾…åˆ†æ...</div>
                            </div>
                        </a>
                        <a id="link-bilibili" target="_blank" class="source-btn flex items-center justify-center gap-3 p-4 rounded-xl bg-[#00aeec] text-white">
                            <span class="text-xl">ğŸ“º</span>
                            <div class="text-left">
                                <div class="text-[10px] opacity-70 font-bold">Bilibili æ¸¸æˆåŒº</div>
                                <div class="text-sm font-bold truncate w-32" id="text-bilibili">ç­‰å¾…åˆ†æ...</div>
                            </div>
                        </a>
                        <a id="link-pinterest" target="_blank" class="source-btn flex items-center justify-center gap-3 p-4 rounded-xl bg-[#bd081c] text-white">
                            <span class="text-xl">ğŸ“Œ</span>
                            <div class="text-left">
                                <div class="text-[10px] opacity-70 font-bold">PINTEREST</div>
                                <div class="text-sm font-bold truncate w-32" id="text-pinterest">Waiting...</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto px-6">
        <div id="grid-header" class="hidden mb-6 flex items-center justify-between">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider border-l-2 border-cyan-500 pl-3">Tenor Live Results</h3>
            <span class="text-[10px] text-zinc-500">Provided by Tenor API</span>
        </div>
        
        <div id="results-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
            </div>
    </main>

    <div id="preview-modal" class="modal" onclick="closeModal()">
        <div class="w-full h-full flex flex-col items-center justify-center p-6" onclick="event.stopPropagation()">
            <div class="relative max-w-5xl max-h-[80vh] w-full bg-[#111] rounded-xl overflow-hidden border border-zinc-700 shadow-2xl flex items-center justify-center">
                <img id="modal-img" class="max-w-full max-h-full object-contain">
            </div>
            <div class="mt-4 flex gap-4">
                <button onclick="saveToEagle()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-sm transition">
                    â¬‡ å­˜å…¥ Eagle
                </button>
                <button onclick="closeModal()" class="px-6 py-2 bg-zinc-800 hover:bg-zinc-700 text-white rounded font-bold text-sm transition">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <script>
        const GEMINI_KEY = "AIzaSyB9ww1axSGsO4iYUt9UaOOJiBAuoa0wYOQ";
        const TENOR_KEY = "LIVDSRZULELA"; // ä½¿ç”¨å…¬å…± Keyï¼Œå¯èƒ½ä¼šå› ä¸ºç½‘ç»œé—®é¢˜å¤±è´¥

        let currentImgUrl = "";

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const resultsGrid = document.getElementById('results-grid');
        const aiTagsDiv = document.getElementById('ai-tags');
        const statusUi = document.getElementById('status-ui');
        const analysisPanel = document.getElementById('analysis-panel');
        const portalLinks = document.getElementById('portal-links');
        const gridHeader = document.getElementById('grid-header');

        dropZone.onclick = () => fileInput.click();
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
        });
        dropZone.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        async function handleFile(file) {
            if (!file) return;
            
            // é‡ç½® UI
            statusUi.innerHTML = `<div class="animate-spin text-4xl mb-4 text-cyan-500">âš™ï¸</div><p class="text-cyan-500 font-bold uppercase tracking-widest text-xs">AI Deep Scanning...</p>`;
            resultsGrid.innerHTML = "";
            aiTagsDiv.innerHTML = "";
            analysisPanel.classList.add('hidden');
            gridHeader.classList.add('hidden');
            portalLinks.classList.remove('opacity-100', 'translate-y-0');

            try {
                const base64 = await toBase64(file);
                
                // 1. Gemini: ä¸“é—¨é’ˆå¯¹æ¸¸æˆ VFX çš„ Prompt
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [
                            { text: "Analyze this image for Game VFX style. Output 3 lines.\nLine 1: 3 specific English keywords for GIF search (e.g. 'unity particle', 'slash vfx').\nLine 2: 1 precise Chinese keyword for Huaban (e.g. æ¸¸æˆç‰¹æ•ˆ, åˆ€å…‰, æŠ€èƒ½ç‰¹æ•ˆ).\nLine 3: 1 precise Chinese keyword for Bilibili (e.g. Unity æ•™ç¨‹, UE5 å®æˆ˜)." },
                            { inline_data: { mime_type: "image/jpeg", data: base64.split(',')[1] } }
                        ]}]
                    })
                });

                const data = await response.json();
                const lines = data.candidates[0].content.parts[0].text.trim().split('\n');
                const engKeywords = lines[0].replace(/Line 1:/i, '').trim();
                const cnHuaban = lines[1] ? lines[1].replace(/Line 2:/i, '').trim() : "æ¸¸æˆç‰¹æ•ˆ";
                const cnBili = lines[2] ? lines[2].replace(/Line 3:/i, '').trim() : "æ¸¸æˆå¼€å‘";

                // 2. æ›´æ–° UI
                statusUi.innerHTML = `<div class="text-4xl mb-4">âœ…</div><p class="text-zinc-400 font-bold text-xs">ANALYSIS COMPLETE</p>`;
                analysisPanel.classList.remove('hidden');
                
                // æ¸²æŸ“æ ‡ç­¾
                const tags = engKeywords.split(/[,]+/).map(t => t.trim());
                aiTagsDiv.innerHTML = tags.map(t => `<span class="px-3 py-1 bg-zinc-800 text-zinc-300 text-[10px] border border-zinc-700 rounded uppercase font-mono">${t}</span>`).join('');

                // 3. æ›´æ–°ç›´è¿æŒ‰é’® (è¿™æ˜¯ 100% å¯ç”¨çš„çœŸå®é“¾æ¥)
                document.getElementById('text-huaban').innerText = `æœ: ${cnHuaban}`;
                document.getElementById('link-huaban').href = `https://huaban.com/search/?q=${encodeURIComponent(cnHuaban)}`;
                
                document.getElementById('text-bilibili').innerText = `æœ: ${cnBili}`;
                document.getElementById('link-bilibili').href = `https://search.bilibili.com/all?keyword=${encodeURIComponent(cnBili)}`;

                document.getElementById('text-pinterest').innerText = `Search: ${tags[0]}`;
                document.getElementById('link-pinterest').href = `https://www.pinterest.com/search/pins/?q=${encodeURIComponent(engKeywords + " game vfx")}`;

                // æ˜¾ç¤ºæŒ‰é’®åŠ¨ç”»
                setTimeout(() => portalLinks.classList.add('opacity-100', 'translate-y-0'), 100);

                // 4. å°è¯•æœç´¢ Tenor (ä¸å¼ºæ±‚ï¼Œå¦‚æœæœ‰ç»“æœå°±æ˜¾ç¤º)
                searchTenor(engKeywords);

            } catch (err) {
                console.error(err);
                statusUi.innerHTML = `<p class="text-red-500 text-sm">AI Analysis Failed.</p>`;
            }
        }

        async function searchTenor(query) {
            try {
                // å¼ºåˆ¶åŠ ä¸Š gameplay vfx è¿‡æ»¤
                const finalQuery = `${query} gameplay vfx`;
                const res = await fetch(`https://g.tenor.com/v1/search?q=${encodeURIComponent(finalQuery)}&key=${TENOR_KEY}&limit=20&media_filter=minimal`);
                const data = await res.json();

                if (data.results && data.results.length > 0) {
                    gridHeader.classList.remove('hidden');
                    resultsGrid.innerHTML = data.results.map((item, index) => `
                        <div class="vfx-card bg-[#111] rounded-lg overflow-hidden relative group cursor-pointer"
                             style="aspect-ratio: 1/1"
                             onclick="openModal('${item.media[0].gif.url}')">
                            <img src="${item.media[0].tinygif.url}" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition duration-300" loading="lazy">
                            <div class="absolute bottom-2 left-2 right-2 bg-black/60 backdrop-blur px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">
                                <p class="text-[9px] text-cyan-400 truncate">${item.content_description || 'VFX GIF'}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    // å¦‚æœæ²¡ç»“æœï¼Œé™é»˜å¤±è´¥ï¼Œåªæ˜¾ç¤ºä¸Šæ–¹çš„èŠ±ç“£æŒ‰é’®
                    resultsGrid.innerHTML = `<div class="col-span-full text-center text-zinc-600 py-10 font-mono text-xs">NO DIRECT GIFS FOUND.<br>USE THE BUTTONS ABOVE TO SEARCH HUABAN/BILIBILI.</div>`;
                }
            } catch (e) {
                // å¦‚æœ API æŒ‚äº†ï¼Œæ˜¾ç¤ºè¯šå®çš„æŠ¥é”™ï¼Œå¹¶å¼•å¯¼ç‚¹å‡»æŒ‰é’®
                resultsGrid.innerHTML = `<div class="col-span-full text-center text-zinc-600 py-10 font-mono text-xs">TENOR API CONNECTION FAILED.<br>PLEASE USE THE DIRECT LINKS ABOVE ğŸ‘†</div>`;
            }
        }

        function openModal(url) {
            currentImgUrl = url;
            const modal = document.getElementById('preview-modal');
            const img = document.getElementById('modal-img');
            img.src = url;
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('preview-modal').classList.remove('active');
            setTimeout(() => document.getElementById('modal-img').src = "", 200);
        }

        async function saveToEagle() {
            try {
                const res = await fetch("http://localhost:44324/api/item/addFromURL", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: currentImgUrl, name: "VFX_" + Date.now(), tags: ["Motiflow"] })
                });
                if (res.ok) alert("âœ… Saved!");
                else throw new Error();
            } catch (e) { alert("âš ï¸ Eagle Connection Failed"); }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>
