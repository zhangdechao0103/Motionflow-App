<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <title>Motiflow VFX - v34 Force Render</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #050505; color: #e0e0e0; }
        
        .portal-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #222; position: relative; overflow: hidden; }
        .portal-card:hover { transform: translateY(-5px); border-color: var(--accent-color); box-shadow: 0 10px 30px -10px var(--shadow-color); }
        .settings-panel { transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .settings-panel.open { transform: translateX(0); }
        
        .upload-active { animation: pulse-ring 2s infinite; border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        
        .model-item { cursor: pointer; padding: 10px; border-bottom: 1px solid #222; font-size: 11px; color: #666; display: flex; justify-content: space-between; align-items: center; }
        .model-item:hover { background: #111; color: white; }
        .model-item.active { background: #1e3a8a; color: #93c5fd; border-left: 3px solid #3b82f6; }
        
        .console-box { font-family: 'Consolas', monospace; font-size: 10px; background: #000; padding: 10px; height: 120px; overflow-y: auto; color: #666; margin-top: 10px; border-top: 1px solid #222; }
        .log-err { color: #f87171; border-left: 2px solid #f87171; padding-left: 5px; } 
        .log-suc { color: #4ade80; border-left: 2px solid #4ade80; padding-left: 5px; }
        
        /* å¼ºåˆ¶å›¾ç‰‡å®¹å™¨æ ·å¼ */
        .eagle-img { width: 100%; height: 100%; object-fit: cover; background: #111; transition: opacity 0.3s; opacity: 0; }
        .eagle-img.loaded { opacity: 1; }
    </style>
</head>
<body class="min-h-screen bg-[#050505] flex flex-col overflow-x-hidden">

    <nav class="sticky top-0 z-40 bg-[#0a0a0a]/90 backdrop-blur-md border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-pink-600 rounded flex items-center justify-center font-bold text-white">34</div>
                <span class="text-lg font-bold tracking-tight text-white">MOTIFLOW <span class="text-pink-500 font-normal">| FORCE</span></span>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2 text-[10px]">
                    <div class="bg-zinc-900 px-3 py-1 rounded-full border border-zinc-800 flex items-center gap-2">
                        <span id="ai-status-dot" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>
                        <span id="current-model-name" class="text-zinc-300 font-mono">æ‰«æä¸­...</span>
                    </div>
                    <div class="bg-zinc-900 px-3 py-1 rounded-full border border-zinc-800 flex items-center gap-2">
                        <span id="eagle-status-dot" class="w-2 h-2 rounded-full bg-red-500"></span>
                        <span id="eagle-status-text" class="text-zinc-300 font-mono">Eagle: ç¦»çº¿</span>
                    </div>
                </div>
                <button onclick="toggleSettings()" class="text-zinc-400 hover:text-white text-xs px-3 py-1 rounded border border-zinc-800 hover:bg-zinc-800 transition">
                    <i class="fas fa-cog"></i> è®¾ç½®
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-7xl mx-auto w-full p-6 flex flex-col gap-8">
        
        <section class="flex flex-col md:flex-row gap-6 items-stretch h-auto md:h-52">
            <div id="drop-area" class="relative group w-full md:w-1/3 border-2 border-dashed border-zinc-800 rounded-2xl hover:border-pink-500 transition cursor-pointer flex flex-col items-center justify-center bg-zinc-900/20 py-8 md:py-0" onclick="triggerUpload()">
                <input type="file" id="file-input" class="hidden" accept="image/*">
                <div id="upload-hint" class="text-center">
                    <i class="fas fa-cloud-upload-alt text-4xl mb-3 text-zinc-600 group-hover:text-pink-500 transition"></i>
                    <p class="text-xs text-zinc-500 font-bold group-hover:text-zinc-300">ç‚¹å‡» / æ‹–æ‹½ / ç²˜è´´</p>
                    <p class="text-[10px] text-zinc-600 mt-1">v34 å¼ºåˆ¶æ¸²æŸ“å¼•æ“</p>
                </div>
                <img id="preview-thumb" class="hidden w-32 h-32 object-contain rounded shadow-lg z-10 cursor-grab active:cursor-grabbing border border-zinc-700 bg-black" draggable="true" title="æŒ‰ä½æ‹–æ‹½è‡³ Eagle">
            </div>

            <div class="w-full md:w-2/3 bg-black border border-zinc-800 rounded-2xl p-4 flex flex-col relative">
                <div class="flex justify-between items-center mb-4 border-b border-zinc-800 pb-2">
                    <span class="text-xs font-bold text-pink-400"><i class="fas fa-magic"></i> AI ANALYSIS HUB</span>
                    
                    <div id="color-info" class="hidden flex items-center gap-2">
                        <div id="color-dot" class="w-3 h-3 rounded-full border border-white/20"></div>
                    </div>

                    <button onclick="resetAll()" class="text-[10px] text-zinc-500 hover:text-white flex items-center gap-1 bg-zinc-900 px-2 py-1 rounded">
                        <i class="fas fa-redo"></i> é‡ç½®
                    </button>
                </div>
                
                <div class="flex-1 flex flex-col justify-center gap-4">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-zinc-500 w-16 text-right font-bold">CN (èŠ±ç“£)</span>
                        <input type="text" id="cn-keywords" class="flex-1 bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-xs text-white focus:border-pink-500 outline-none transition" placeholder="AI å‡†å¤‡ä¸­...">
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-zinc-500 w-16 text-right font-bold">EN (Eagle)</span>
                        <input type="text" id="en-keywords" class="flex-1 bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-xs text-white focus:border-pink-500 outline-none transition" placeholder="AI Ready...">
                    </div>
                </div>
                
                <div class="mt-4 flex justify-between items-center">
                    <div class="flex items-center gap-2 text-[10px] text-zinc-500">
                        <i class="fas fa-info-circle"></i>
                        <span>æ”¯æŒå°†å·¦ä¾§å›¾ <b class="text-pink-400">æ‹–å…¥ Eagle æœç´¢æ¡†</b></span>
                    </div>
                    <button onclick="refreshLinks()" class="bg-pink-600 hover:bg-pink-500 text-white text-xs px-4 py-2 rounded font-bold shadow-lg shadow-pink-900/50 transition">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°æœç´¢
                    </button>
                </div>
            </div>
        </section>

        <section class="border-t border-zinc-900 pt-6 transition-all duration-300">
            <h2 class="text-xs font-bold text-zinc-500 mb-4 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-pink-500 animate-pulse"></span> Eagle æœ¬åœ°åº“ (Blob æ¸²æŸ“)
            </h2>
            <div id="results-grid" class="grid grid-cols-2 md:grid-cols-6 lg:grid-cols-8 gap-4 min-h-[100px]">
                <div class="col-span-full text-center py-10 text-zinc-700 text-xs">
                    ç­‰å¾…å›¾ç‰‡ä¸Šä¼ ...<br>
                    <span class="text-pink-500 mt-2 block opacity-80">(è‹¥æ— ç»“æœï¼Œè¯·æ£€æŸ¥ Token å¹¶å¼€å¯ API)</span>
                </div>
            </div>
        </section>

        <section>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a id="link-huaban" target="_blank" class="portal-card bg-[#c8222c]/10 rounded-xl p-4 flex flex-col gap-2 group cursor-pointer" style="--accent-color: #c8222c; --shadow-color: rgba(200, 34, 44, 0.4);">
                    <div class="flex justify-between"><i class="fas fa-flower text-xl text-[#c8222c]"></i><i class="fas fa-external-link-alt text-[#c8222c] opacity-50"></i></div>
                    <div><h3 class="font-bold text-white text-sm">èŠ±ç“£ç½‘</h3><p class="text-[10px] text-zinc-400">ä¸­æ–‡çµæ„Ÿåº“</p></div>
                </a>
                <a id="link-pinterest" target="_blank" class="portal-card bg-[#bd081c]/10 rounded-xl p-4 flex flex-col gap-2 group cursor-pointer" style="--accent-color: #bd081c; --shadow-color: rgba(189, 8, 28, 0.4);">
                    <div class="flex justify-between"><i class="fab fa-pinterest text-xl text-[#bd081c]"></i><i class="fas fa-external-link-alt text-[#bd081c] opacity-50"></i></div>
                    <div><h3 class="font-bold text-white text-sm">Pinterest</h3><p class="text-[10px] text-zinc-400">å…¨çƒå‚è€ƒ</p></div>
                </a>
                <a id="link-artstation" target="_blank" class="portal-card bg-[#13aff0]/10 rounded-xl p-4 flex flex-col gap-2 group cursor-pointer" style="--accent-color: #13aff0; --shadow-color: rgba(19, 175, 240, 0.4);">
                    <div class="flex justify-between"><i class="fab fa-artstation text-xl text-[#13aff0]"></i><i class="fas fa-external-link-alt text-[#13aff0] opacity-50"></i></div>
                    <div><h3 class="font-bold text-white text-sm">ArtStation</h3><p class="text-[10px] text-zinc-400">ä¸“ä¸šç¾æœ¯</p></div>
                </a>
                <a id="link-bilibili" target="_blank" class="portal-card bg-[#00aeec]/10 rounded-xl p-4 flex flex-col gap-2 group cursor-pointer" style="--accent-color: #00aeec; --shadow-color: rgba(0, 174, 236, 0.4);">
                    <div class="flex justify-between"><i class="fab fa-bilibili text-xl text-[#00aeec]"></i><i class="fas fa-external-link-alt text-[#00aeec] opacity-50"></i></div>
                    <div><h3 class="font-bold text-white text-sm">Bilibili</h3><p class="text-[10px] text-zinc-400">è§†é¢‘æ•™ç¨‹</p></div>
                </a>
            </div>
        </section>

    </main>

    <div id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-[450px] bg-[#0d0d0d] border-l border-zinc-800 z-50 p-6 shadow-2xl flex flex-col gap-4 overflow-y-auto">
        <div class="flex justify-between items-center">
            <h2 class="font-bold text-white">âš™ï¸ å¼ºåŠ›é…ç½®</h2>
            <button onclick="toggleSettings()" class="text-zinc-500 hover:text-white">âœ•</button>
        </div>
        
        <div class="p-3 bg-zinc-900 border border-zinc-700 rounded">
            <label class="text-xs font-bold text-pink-400 block mb-2">Google API Key (æœ¬åœ°å­˜å‚¨)</label>
            <input type="text" id="api-key-input" class="w-full bg-black border border-zinc-700 rounded p-2 text-xs text-white font-mono mb-2" placeholder="AIzaSy...">
            
            <label class="text-xs font-bold text-pink-400 block mb-2">Base URL (ä»£ç†åœ°å€)</label>
            <input type="text" id="base-url-input" class="w-full bg-black border border-zinc-700 rounded p-2 text-xs text-white font-mono" placeholder="https://generativelanguage.googleapis.com">
        </div>

        <div class="p-3 bg-red-900/20 border border-red-700/50 rounded">
            <label class="block text-xs font-bold text-red-400 mb-1">Eagle Token (å¿…å¡«)</label>
            <p class="text-[10px] text-zinc-400 mb-2">Eagle > åå¥½è®¾ç½® > å¼€å‘è€… > å¼€å¯ API > å¤åˆ¶ Token</p>
            <input type="text" id="eagle-token-input" class="w-full bg-black border border-red-700 rounded p-2 text-xs text-white font-mono" placeholder="ç²˜è´´ Token...">
            <button onclick="checkEagleStatus()" class="mt-2 w-full text-[10px] bg-red-800 text-white py-1 rounded">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
        </div>

        <div class="flex-1 flex flex-col min-h-[150px]">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-xs font-bold text-zinc-500">æ¨¡å‹åˆ—è¡¨</label>
                <button onclick="autoDiscoverModel()" class="text-[10px] text-pink-400 hover:text-pink-300">âš¡ é‡æ–°æ‰«æ</button>
            </div>
            <div id="model-list" class="flex-1 bg-zinc-900 border border-zinc-700 rounded overflow-y-auto"></div>
        </div>
        
        <div class="console-box" id="debug-log">Log initialized.</div>

        <button onclick="saveSettings()" class="w-full py-3 bg-pink-600 hover:bg-pink-500 text-white rounded text-sm font-bold">ä¿å­˜å¹¶åº”ç”¨</button>
    </div>
    <div id="settings-overlay" onclick="toggleSettings()" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm"></div>

    <script>
        const DEFAULT_KEY = "AIzaSyB1mVPeECC27nWMhn49NBOT8_-PIJQmmEI";
        const EAGLE_API_URL = "http://127.0.0.1:41595";
        
        let CONFIG = {
            apiKey: "",
            baseUrl: "https://generativelanguage.googleapis.com", 
            endpoint: "",
            eagleToken: ""
        };
        
        let targetColorRGB = null;

        function init() {
            if(localStorage.getItem('motiflow_v34')) {
                const saved = JSON.parse(localStorage.getItem('motiflow_v34'));
                if(saved.baseUrl) CONFIG.baseUrl = saved.baseUrl;
                if(saved.endpoint) CONFIG.endpoint = saved.endpoint;
                if(saved.eagleToken) CONFIG.eagleToken = saved.eagleToken;
                // CONFIG.apiKey = saved.apiKey; 
            }
            CONFIG.apiKey = DEFAULT_KEY; // å¼ºåˆ¶ä»£ç å†…Key
            
            document.getElementById('api-key-input').value = CONFIG.apiKey;
            document.getElementById('base-url-input').value = CONFIG.baseUrl;
            document.getElementById('eagle-token-input').value = CONFIG.eagleToken;
            
            checkEagleStatus();
            if (!CONFIG.endpoint) autoDiscoverModel();
            else { updateModelLabel(); scanModelList(true); }
        }

        // --- 1. è‡ªåŠ¨æ¨¡å‹å‘ç° ---
        async function autoDiscoverModel() {
            log("æ‰«æå¯ç”¨æ¨¡å‹...");
            try {
                const url = `${CONFIG.baseUrl}/v1beta/models?key=${CONFIG.apiKey}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.models) {
                    const best = data.models.find(m => m.name.includes('flash')) || data.models[0];
                    CONFIG.endpoint = `/v1beta/models/${best.name.replace('models/', '')}:generateContent`;
                    log(`âœ… è‡ªåŠ¨é€‰ä¸­: ${best.name}`, 'suc');
                    updateModelLabel();
                    scanModelList(true);
                    saveSettings(true);
                }
            } catch(e) { log(`æ‰«æå¤±è´¥: ${e.message}`, 'err'); }
        }

        function updateModelLabel() {
            const name = CONFIG.endpoint.match(/models\/(.*?):/)?.[1] || "Unknown";
            document.getElementById('current-model-name').innerText = name;
            document.getElementById('ai-status-dot').className = "w-2 h-2 rounded-full bg-green-500";
        }

        // --- 2. Eagle è¿æ¥ ---
        async function checkEagleStatus() {
            if(!CONFIG.eagleToken) return;
            try {
                const res = await fetch(`${EAGLE_API_URL}/api/application/info?token=${CONFIG.eagleToken}`);
                if(res.ok) {
                    document.getElementById('eagle-status-dot').className = "w-2 h-2 rounded-full bg-green-500";
                    document.getElementById('eagle-status-text').innerText = "Eagle: åœ¨çº¿";
                    log("Eagle Connected.", "suc");
                } else throw new Error("401");
            } catch(e) {
                document.getElementById('eagle-status-dot').className = "w-2 h-2 rounded-full bg-red-500";
                document.getElementById('eagle-status-text').innerText = "Eagle: ç¦»çº¿";
            }
        }

        // --- 3. æ ¸å¿ƒä¸Šä¼  ---
        async function handleFiles(file) {
            if(!CONFIG.endpoint) await autoDiscoverModel();
            
            const url = URL.createObjectURL(file);
            const img = document.getElementById('preview-thumb');
            img.src = url;
            img.classList.remove('hidden');
            document.getElementById('upload-hint').classList.add('hidden');
            img.onload = () => { extractColor(img); };

            document.getElementById('cn-keywords').placeholder = "Connecting...";
            document.getElementById('en-keywords').placeholder = "Connecting...";
            document.getElementById('results-grid').innerHTML = '<div class="col-span-full text-center py-10 text-pink-500 animate-pulse text-xs">AI è¯†åˆ«ä¸­...</div>';

            try {
                const base64 = await toBase64(file);
                const prompt = `Identify the Game VFX. Output ONLY a JSON object.
{"cn": "Chinese Keywords for Huaban", "en": "English Keywords for ArtStation"}
`;
                
                const res = await fetch(`${CONFIG.baseUrl}${CONFIG.endpoint}?key=${CONFIG.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64.split(',')[1] } } ]}],
                        safetySettings: [{ category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }]
                    })
                });

                const raw = await res.text();
                if(!res.ok) throw new Error(res.status);

                let result = { cn: "ç‰¹æ•ˆ", en: "VFX" };
                try { result = JSON.parse(raw.match(/\{[\s\S]*\}/)?.[0] || raw); } catch(e) {}

                document.getElementById('cn-keywords').value = result.cn || "ç‰¹æ•ˆ";
                document.getElementById('en-keywords').value = result.en || "VFX";
                refreshLinks(result.en);

            } catch(e) {
                log(e.message, 'err');
                document.getElementById('results-grid').innerHTML = `<div class="col-span-full text-center text-red-500 text-xs">è¯·æ±‚å¤±è´¥: ${e.message}</div>`;
            }
        }

        // --- 4. Eagle æœç´¢ (å¼ºåˆ¶ Blob æ¸²æŸ“) ---
        async function searchEagle(keyword) {
            if(!CONFIG.eagleToken) {
                document.getElementById('results-grid').innerHTML = '<div class="col-span-full text-center py-10 text-red-500 text-xs">æœªè®¾ç½® Token</div>';
                return;
            }

            const grid = document.getElementById('results-grid');
            grid.innerHTML = '<div class="col-span-full text-center py-10 text-zinc-500 text-xs">æœç´¢æœ¬åœ°åº“...</div>';
            
            try {
                let apiUrl = `${EAGLE_API_URL}/api/item/list?keyword=${encodeURIComponent(keyword)}&limit=100&token=${CONFIG.eagleToken}`;
                const res = await fetch(apiUrl);
                const json = await res.json();
                
                if(json.data && json.data.length > 0) {
                    let items = json.data;
                    // é¢œè‰²æ’åº
                    if (targetColorRGB) {
                        items.forEach(item => {
                            if (item.palettes && item.palettes.length > 0) {
                                const itemRgb = hexToRgb("#" + item.palettes[0].color);
                                item.colorDist = itemRgb ? getColorDistance(targetColorRGB, itemRgb) : 9999;
                            } else { item.colorDist = 9999; }
                        });
                        items.sort((a, b) => a.colorDist - b.colorDist);
                    }

                    // æ¸²æŸ“åˆ—è¡¨ (é™åˆ¶å‰18ä¸ª)
                    const renderedItems = await Promise.all(items.slice(0, 18).map(async item => {
                        // æ ¸å¿ƒé»‘ç§‘æŠ€: å¼ºåˆ¶ Fetch å›¾ç‰‡æ•°æ®è½¬ Blob
                        const imgUrl = `${EAGLE_API_URL}/api/item/thumbnail?id=${item.id}&token=${CONFIG.eagleToken}`;
                        let blobUrl = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PC9zdmc+"; // é»˜è®¤å ä½
                        
                        try {
                            const imgRes = await fetch(imgUrl);
                            if(imgRes.ok) {
                                const blob = await imgRes.blob();
                                blobUrl = URL.createObjectURL(blob);
                            }
                        } catch(e) { console.warn("Img load fail", item.id); }

                        return `
                        <div class="bg-zinc-900 rounded overflow-hidden cursor-pointer opacity-90 hover:opacity-100 transition border border-zinc-800 hover:border-pink-500 relative group" onclick="window.open('eagle://item/${item.id}')">
                            <div class="aspect-square relative">
                                <img src="${blobUrl}" class="eagle-img" onload="this.classList.add('loaded')">
                            </div>
                            <div class="p-1 text-[9px] text-zinc-400 truncate">${item.name}</div>
                        </div>
                    `;
                    }));
                    
                    grid.innerHTML = renderedItems.join('');
                    
                } else {
                    grid.innerHTML = '<div class="col-span-full text-center py-10 text-zinc-600 text-xs">æœ¬åœ°æ— ç»“æœ</div>';
                }
            } catch(e) {
                grid.innerHTML = `<div class="col-span-full text-center py-10 text-red-500 text-xs">è¿æ¥é”™è¯¯: ${e.message}</div>`;
            }
        }

        // --- è¾…åŠ©å‡½æ•° ---
        function refreshLinks(k) {
            const cn = document.getElementById('cn-keywords').value.trim();
            const en = document.getElementById('en-keywords').value.trim();
            document.getElementById('link-huaban').href = `https://huaban.com/search/?q=${encodeURIComponent(cn)}`;
            document.getElementById('link-pinterest').href = `https://www.pinterest.com/search/pins/?q=${encodeURIComponent(en)}`;
            document.getElementById('link-artstation').href = `https://www.artstation.com/search?sort_by=relevance&query=${encodeURIComponent(en)}`;
            document.getElementById('link-bilibili').href = `https://search.bilibili.com/all?keyword=${encodeURIComponent(cn + " æ•™ç¨‹")}`;
            searchEagle(k || en);
        }

        function extractColor(img) {
            const c = document.createElement('canvas'); const x = c.getContext('2d');
            c.width = 1; c.height = 1; x.drawImage(img,0,0,1,1);
            const p = x.getImageData(0,0,1,1).data;
            targetColorRGB = { r:p[0], g:p[1], b:p[2] };
            document.getElementById('color-dot').style.backgroundColor = `rgb(${p[0]},${p[1]},${p[2]})`;
            document.getElementById('color-info').classList.remove('hidden');
        }
        function getColorDistance(c1, c2) { return Math.sqrt(Math.pow(c1.r-c2.r,2)+Math.pow(c1.g-c2.g,2)+Math.pow(c1.b-c2.b,2)); }
        function hexToRgb(hex) { var r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return r ? {r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)} : null; }
        
        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('open');
            document.getElementById('settings-overlay').classList.toggle('hidden');
        }
        function log(msg, type='info') {
            const box = document.getElementById('debug-log');
            box.innerHTML += `<div class="${type==='err'?'log-err':(type==='suc'?'log-suc':'')}">> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }
        function saveSettings(silent) {
            CONFIG.baseUrl = document.getElementById('base-url-input').value.trim().replace(/\/$/, "");
            CONFIG.eagleToken = document.getElementById('eagle-token-input').value.trim();
            localStorage.setItem('motiflow_v34', JSON.stringify(CONFIG));
            if(!silent) { alert("ä¿å­˜æˆåŠŸ"); toggleSettings(); }
            checkEagleStatus();
        }
        function resetAll() {
            document.getElementById('cn-keywords').value = "";
            document.getElementById('en-keywords').value = "";
            document.getElementById('preview-thumb').classList.add('hidden');
            document.getElementById('upload-hint').classList.remove('hidden');
            document.getElementById('results-grid').innerHTML = '<div class="col-span-full text-center py-10 text-zinc-700 text-xs">ç­‰å¾…ä¸Šä¼ ...</div>';
        }
        async function scanModelList(silent=false) {
             const list = document.getElementById('model-list');
             try {
                 const res = await fetch(`${CONFIG.baseUrl}/v1beta/models?key=${CONFIG.apiKey}`);
                 const data = await res.json();
                 list.innerHTML = "";
                 data.models.forEach(m => {
                     if(m.supportedGenerationMethods?.includes('generateContent') && !m.name.includes('banana')) {
                         const name = m.name.replace('models/','');
                         const div = document.createElement('div');
                         div.className = `model-item ${CONFIG.endpoint.includes(name)?'active':''}`;
                         div.innerHTML = `<span>${name}</span>`;
                         div.onclick = () => { CONFIG.endpoint = `/v1beta/models/${name}:generateContent`; saveSettings(); };
                         list.appendChild(div);
                     }
                 });
             } catch(e){}
        }
        function toBase64(file) { return new Promise((r) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => r(reader.result); }); }
        
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        function triggerUpload() { if(!document.getElementById('preview-thumb').src) fileInput.click(); }
        // ç‚¹å‡»é¢„è§ˆå›¾æœ¬èº«ä¸è§¦å‘ä¸Šä¼ 
        document.getElementById('preview-thumb').addEventListener('click', (e) => e.stopPropagation());

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }));
        dropArea.addEventListener('drop', e => { if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', e => { if(e.target.files.length) handleFiles(e.target.files[0]); });
        document.addEventListener('paste', e => { if(e.clipboardData.files.length) handleFiles(e.clipboardData.files[0]); });

        init();
    </script>
</body>
</html>
