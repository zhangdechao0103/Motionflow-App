<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <title>Motiflow VFX - å¯¼æ¼”æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #050505; color: #e0e0e0; }
        .glass { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* é€‰ä¸­æ€é«˜äº® */
        .tag-btn.active { background-color: #00e5ff; color: black; border-color: #00e5ff; box-shadow: 0 0 15px rgba(0, 229, 255, 0.4); }
        .tag-btn { transition: all 0.2s; user-select: none; }
        
        .vfx-card { transition: all 0.2s; border: 1px solid #222; }
        .vfx-card:hover { transform: translateY(-4px); border-color: #00e5ff; z-index: 10; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 100; opacity: 0; transition: opacity 0.2s; }
        .modal.active { display: flex; opacity: 1; }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="min-h-screen bg-[#080808]">

    <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-cyan-600 rounded flex items-center justify-center font-bold text-black">M</div>
            <span class="text-lg font-bold tracking-tight text-white">MOTIFLOW <span class="text-cyan-500 font-normal">| DIRECTOR</span></span>
        </div>
        <div class="text-[10px] text-zinc-500 font-mono">V9.0 STABLE</div>
    </nav>

    <div class="max-w-[1600px] mx-auto flex flex-col lg:flex-row min-h-[calc(100vh-80px)]">
        
        <aside class="w-full lg:w-[400px] p-6 lg:border-r border-white/5 flex flex-col gap-6 bg-[#0a0a0a]">
            
            <div id="drop-zone" class="relative p-8 border border-dashed border-zinc-700 rounded-2xl bg-zinc-900/40 text-center hover:border-cyan-500/50 transition-all cursor-pointer group">
                <input type="file" id="file-input" class="hidden" accept="image/*">
                <div id="status-ui">
                    <div class="text-4xl mb-3 opacity-80 group-hover:scale-110 transition">ğŸ“¥</div>
                    <p class="text-zinc-400 text-xs font-bold">ç‚¹å‡»ä¸Šä¼ å‚è€ƒå›¾</p>
                    <p class="text-zinc-600 text-[10px] mt-1">AI è‡ªåŠ¨æå– + äººå·¥ä¿®æ­£</p>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="flex justify-between items-end">
                    <h3 class="text-xs font-bold text-cyan-500 uppercase tracking-widest">TAG BUILDER</h3>
                    <button onclick="clearTags()" class="text-[10px] text-red-400 hover:text-red-300">æ¸…é™¤å…¨éƒ¨</button>
                </div>
                
                <div class="bg-black border border-zinc-700 p-3 rounded-lg min-h-[40px] flex flex-wrap gap-2" id="active-tags-container">
                    <span class="text-zinc-600 text-xs italic p-1">è¯·é€‰æ‹©ä¸‹æ–¹æ ‡ç­¾æˆ–ä¸Šä¼ å›¾ç‰‡...</span>
                </div>

                <div class="space-y-4">
                    <div>
                        <p class="text-[10px] text-zinc-500 mb-2">å¼•æ“ / é£æ ¼ (å¿…é€‰)</p>
                        <div class="flex flex-wrap gap-2">
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Unity VFX')">Unity</button>
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('UE5 Particle')">UE5</button>
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Pixel Art')">åƒç´ </button>
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Anime Style')">äºŒæ¬¡å…ƒ</button>
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Low Poly')">LowPoly</button>
                        </div>
                    </div>
                    <div>
                        <p class="text-[10px] text-zinc-500 mb-2">å…ƒç´  / å½¢æ€</p>
                        <div class="flex flex-wrap gap-2">
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Slash')">åˆ€å…‰</button>
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Explosion')">çˆ†ç‚¸</button>
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Magic Circle')">æ³•é˜µ</button>
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Lightning')">é—ªç”µ</button>
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Fire')">ç«ç„°</button>
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Ice')">å†°éœœ</button>
                            <button class="tag-btn border border-zinc-700 bg-zinc-900/50 text-zinc-400 px-3 py-1 rounded text-xs hover:border-zinc-500" onclick="toggleTag('Hologram UI')">å…¨æ¯UI</button>
                        </div>
                    </div>
                </div>

                <button onclick="executeSearch()" class="w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-lg shadow-lg shadow-cyan-900/50 transition mt-4">
                    ğŸš€ å¼€å§‹ç²¾å‡†æœç´¢
                </button>
            </div>
            
            <div class="mt-auto pt-6 border-t border-white/5 grid grid-cols-2 gap-3">
                <a id="link-huaban" href="https://huaban.com/search/?q=æ¸¸æˆç‰¹æ•ˆ" target="_blank" class="p-3 bg-[#c8222c]/10 border border-[#c8222c]/30 rounded-lg hover:bg-[#c8222c] hover:text-white text-[#c8222c] text-xs font-bold text-center transition flex items-center justify-center gap-2">
                    <span>ğŸŒ¸ èŠ±ç“£ç½‘</span>
                </a>
                <a id="link-bilibili" href="https://search.bilibili.com/all?keyword=Unityç‰¹æ•ˆæ•™ç¨‹" target="_blank" class="p-3 bg-[#00aeec]/10 border border-[#00aeec]/30 rounded-lg hover:bg-[#00aeec] hover:text-white text-[#00aeec] text-xs font-bold text-center transition flex items-center justify-center gap-2">
                    <span>ğŸ“º Bilibili</span>
                </a>
            </div>
        </aside>

        <main class="flex-1 p-6 bg-[#050505] h-screen overflow-y-auto" id="main-scroll">
            <div id="results-header" class="mb-4 flex items-center justify-between">
                <h2 class="text-sm font-bold text-white">SEARCH RESULTS</h2>
                <span class="text-[10px] text-zinc-600 font-mono">POWERED BY TENOR | FILTERED BY AI</span>
            </div>
            
            <div id="results-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                <div class="col-span-full text-center py-20 text-zinc-700 border-2 border-dashed border-zinc-800 rounded-xl">
                    <p class="text-sm">ğŸ‘ˆ è¯·åœ¨å·¦ä¾§ä¸Šä¼ å›¾ç‰‡æˆ–é€‰æ‹©æ ‡ç­¾å¼€å§‹</p>
                </div>
            </div>
            <div id="loader" class="hidden text-center py-4 text-cyan-500 text-xs animate-pulse">LOADING MORE VFX...</div>
        </main>
    </div>

    <div id="preview-modal" class="modal" onclick="closeModal()">
        <div class="w-full h-full flex flex-col items-center justify-center p-6" onclick="event.stopPropagation()">
            <div class="relative max-w-5xl max-h-[80vh] w-full bg-[#111] rounded-lg overflow-hidden border border-zinc-800 shadow-2xl">
                <img id="modal-img" class="w-full h-full object-contain">
            </div>
            <div class="mt-6 flex gap-4">
                <a id="source-btn" href="#" target="_blank" class="px-6 py-3 bg-zinc-800 hover:bg-white hover:text-black text-white rounded font-bold text-sm transition border border-zinc-700">
                    ğŸ”— æ¥æºç½‘ç«™
                </a>
                <button onclick="saveToEagle()" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold text-sm shadow-[0_0_20px_rgba(8,145,178,0.4)] transition">
                    â¬‡ ä¿å­˜åˆ° Eagle
                </button>
                <button onclick="closeModal()" class="w-12 h-12 rounded-full border border-white/20 hover:bg-white/10 text-white transition flex items-center justify-center">âœ•</button>
            </div>
        </div>
    </div>

    <script>
        const GEMINI_KEY = "AIzaSyB9ww1axSGsO4iYUt9UaOOJiBAuoa0wYOQ";
        const TENOR_KEY = "LIVDSRZULELA";

        // çŠ¶æ€ç®¡ç†
        let activeTags = new Set();
        let nextCursor = "";
        let currentQuery = "";
        let isLoading = false;
        let currentImgUrl = "";

        // DOM
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const tagsContainer = document.getElementById('active-tags-container');
        const statusUi = document.getElementById('status-ui');
        const resultsGrid = document.getElementById('results-grid');
        const mainScroll = document.getElementById('main-scroll');
        const loader = document.getElementById('loader');

        // ä¸Šä¼ é€»è¾‘
        dropZone.onclick = () => fileInput.click();
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
        });
        dropZone.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        // æ— é™æ»šåŠ¨
        mainScroll.addEventListener('scroll', () => {
            if (mainScroll.scrollTop + mainScroll.clientHeight >= mainScroll.scrollHeight - 300) {
                if (!isLoading && nextCursor) fetchTenor(currentQuery, true);
            }
        });

        async function handleFile(file) {
            if (!file) return;
            statusUi.innerHTML = `<p class="text-cyan-400 text-xs font-bold animate-pulse">AI åˆ†æä¸­...</p>`;
            
            try {
                const base64 = await toBase64(file);
                // ä¸“é—¨é’ˆå¯¹ VFX çš„ Prompt
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [
                            { text: "Analyze this game VFX image. Identify:\n1. Engine/Style (Unity, UE5, Pixel Art, Anime)\n2. Element (Fire, Ice, Slash, Explosion, Magic)\nOutput ONLY English keywords separated by comma." },
                            { inline_data: { mime_type: "image/jpeg", data: base64.split(',')[1] } }
                        ]}]
                    })
                });

                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                const keywords = data.candidates[0].content.parts[0].text.split(',');
                
                // å°† AI ç»“æœæ·»åŠ åˆ°æ ‡ç­¾æ± 
                keywords.forEach(k => activeTags.add(k.trim()));
                renderActiveTags();
                statusUi.innerHTML = `<p class="text-green-400 text-xs font-bold">åˆ†æå®Œæˆ</p>`;
                
                // è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡æœç´¢
                executeSearch();

            } catch (err) {
                console.error(err);
                statusUi.innerHTML = `<p class="text-red-400 text-xs font-bold">AI ç¦»çº¿ - è¯·æ‰‹åŠ¨é€‰æ ‡ç­¾</p>`;
            }
        }

        // æ ‡ç­¾ç³»ç»Ÿé€»è¾‘
        function toggleTag(tag) {
            if (activeTags.has(tag)) activeTags.delete(tag);
            else activeTags.add(tag);
            renderActiveTags();
        }

        function clearTags() {
            activeTags.clear();
            renderActiveTags();
        }

        function renderActiveTags() {
            if (activeTags.size === 0) {
                tagsContainer.innerHTML = `<span class="text-zinc-600 text-xs italic p-1">è¯·é€‰æ‹©ä¸‹æ–¹æ ‡ç­¾æˆ–ä¸Šä¼ å›¾ç‰‡...</span>`;
                return;
            }
            tagsContainer.innerHTML = Array.from(activeTags).map(tag => `
                <span class="bg-cyan-900/30 text-cyan-400 border border-cyan-500/30 px-2 py-1 rounded text-xs flex items-center gap-2 cursor-pointer hover:bg-red-900/30 hover:text-red-400 hover:border-red-500/30 transition" onclick="toggleTag('${tag}')">
                    ${tag} âœ•
                </span>
            `).join('');

            // åŒæ­¥æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tag-btn').forEach(btn => {
                if (activeTags.has(btn.innerText)) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            // åŠ¨æ€æ›´æ–°å¤–éƒ¨ä¼ é€é—¨é“¾æ¥
            const queryStr = Array.from(activeTags).join(' ');
            document.getElementById('link-huaban').href = `https://huaban.com/search/?q=${encodeURIComponent(queryStr + " æ¸¸æˆç‰¹æ•ˆ")}`;
            document.getElementById('link-bilibili').href = `https://search.bilibili.com/all?keyword=${encodeURIComponent(queryStr + " Unityæ•™ç¨‹")}`;
        }

        // æ ¸å¿ƒæœç´¢é€»è¾‘
        function executeSearch() {
            if (activeTags.size === 0) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ ‡ç­¾ï¼");
            
            // æ„é€ å¼ºåŠ›è¿‡æ»¤è¯
            const baseQuery = Array.from(activeTags).join(' ');
            // è´Ÿé¢è¯è¿‡æ»¤ + å¼ºåˆ¶æ¸¸æˆåç¼€
            currentQuery = `${baseQuery} gameplay vfx -meme -funny -text -cartoon`; 
            
            nextCursor = "";
            resultsGrid.innerHTML = "";
            fetchTenor(currentQuery);
        }

        async function fetchTenor(query, isAppend = false) {
            isLoading = true;
            loader.style.display = 'block';

            try {
                let url = `https://g.tenor.com/v1/search?q=${encodeURIComponent(query)}&key=${TENOR_KEY}&limit=20&media_filter=minimal`;
                if (isAppend && nextCursor) url += `&pos=${nextCursor}`;

                const res = await fetch(url);
                const data = await res.json();
                nextCursor = data.next || "";

                if (data.results && data.results.length > 0) {
                    const html = data.results.map(item => `
                        <div class="vfx-card bg-[#111] rounded-lg overflow-hidden relative cursor-pointer group aspect-square"
                             onclick="openModal('${item.media[0].gif.url}', '${item.itemurl}')">
                            <img src="${item.media[0].tinygif.url}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-300">
                        </div>
                    `).join('');

                    if (isAppend) resultsGrid.insertAdjacentHTML('beforeend', html);
                    else resultsGrid.innerHTML = html;
                } else if (!isAppend) {
                    resultsGrid.innerHTML = `<div class="col-span-full text-center py-20 text-zinc-500">æœªæ‰¾åˆ°ç›¸å…³ç»“æœï¼Œè¯·å°è¯•å‡å°‘æ ‡ç­¾æˆ–æ›´æ¢ç»„åˆã€‚</div>`;
                }
            } catch (e) {
                if (!isAppend) resultsGrid.innerHTML = `<div class="col-span-full text-center py-20 text-red-500">æ— æ³•è¿æ¥ç´ æåº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ä½¿ç”¨å·¦ä¸‹è§’ä¼ é€é—¨ã€‚</div>`;
            } finally {
                isLoading = false;
                loader.style.display = 'none';
            }
        }

        function openModal(url, sourceUrl) {
            currentImgUrl = url;
            document.getElementById('modal-img').src = url;
            document.getElementById('source-btn').href = sourceUrl;
            document.getElementById('preview-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('preview-modal').classList.remove('active');
            setTimeout(() => document.getElementById('modal-img').src = '', 200);
        }

        async function saveToEagle() {
            try {
                await fetch("http://localhost:44324/api/item/addFromURL", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: currentImgUrl, name: "VFX_" + Date.now(), tags: ["Motiflow"] })
                });
                alert("âœ… å·²ä¿å­˜åˆ° Eagle!");
            } catch (e) { alert("âš ï¸ Eagle æœªå¯åŠ¨"); }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>
